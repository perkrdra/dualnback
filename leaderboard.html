<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Training Leaderboard - Top Dual N-Back Players | UltimateBrain.io</title>
    <meta name="description" content="See the top performers in dual n-back brain training. Compare your cognitive training scores with players worldwide. View highest levels achieved and best scores in working memory challenges.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .leaderboard-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .leaderboard-table {
            width: 100%;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .leaderboard-header {
            background-color: #2552a3;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .leaderboard-header h2 {
            margin: 0;
            font-size: 1.8em;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: #2552a3;
            border-bottom: 2px solid #e9ecef;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .rank {
            font-weight: bold;
            color: #2552a3;
            font-size: 1.2em;
        }
        
        .rank-1 {
            color: #FFD700;
            font-size: 1.4em;
        }
        
        .rank-2 {
            color: #C0C0C0;
            font-size: 1.3em;
        }
        
        .rank-3 {
            color: #CD7F32;
            font-size: 1.3em;
        }
        
        .username {
            font-weight: bold;
            color: #333;
        }
        
        .level {
            font-size: 1.1em;
            font-weight: bold;
            color: #ea6a4b;
        }
        
        .user-highlight {
            background-color: #fff4e6;
            font-weight: bold;
        }
        
        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .stat-box {
            flex: 1;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2552a3;
        }
        
        .filter-section {
            margin-bottom: 20px;
            text-align: center;
        }
        
        
        .country-flag {
            font-size: 1.2em;
            margin-right: 8px;
        }

        .challenge-champion {
            background: linear-gradient(135deg, #fff4e6 0%, #ffe6b3 100%);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            border-left: 4px solid #FFD700;
        }

        .challenge-winner {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
            border-left: 4px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="/" class="domain-name">
            <img src="favicon.svg" alt="UltimateBrain.io Logo" class="logo-icon">
            UltimateBrain.io
        </a>
        <a href="/" class="study-link">Back to Training</a>
    </div>

    <div id="game-container">
        <h1>Global Leaderboard</h1>
        <p class="tagline">See how you rank among cognitive champions</p>
        
        <div class="leaderboard-container">
            <div class="stats-row" id="user-stats">
                <!-- User stats will be displayed here -->
            </div>
            
            <div class="filter-section">
                <div class="location-filters">
                    <button class="location-filter-btn active" onclick="filterByLocation('all')">üåç All Countries</button>
                    <button class="location-filter-btn" onclick="filterByLocation('country')">üè≥Ô∏è My Country</button>
                </div>
            </div>
            
            <div class="leaderboard-table">
                <div class="leaderboard-header">
                    <h2>Top Players</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 8%; text-align: center;">Rank</th>
                            <th style="width: 22%;">Player</th>
                            <th style="width: 12%; text-align: center;">Highest Level</th>
                            <th style="width: 12%; text-align: center;">Best Score</th>
                            <th style="width: 12%; text-align: center;">Challenge Wins</th>
                            <th style="width: 34%;">Enhancements Used</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Leaderboard entries will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentLocationFilter = 'all';
        let allLeaderboardData = [];
        
        // Country code to flag emoji mapping
        const countryFlags = {
            'US': 'üá∫üá∏', 'GB': 'üá¨üáß', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'DE': 'üá©üá™',
            'FR': 'üá´üá∑', 'IT': 'üáÆüáπ', 'ES': 'üá™üá∏', 'NL': 'üá≥üá±', 'SE': 'üá∏üá™',
            'NO': 'üá≥üá¥', 'DK': 'üá©üá∞', 'FI': 'üá´üáÆ', 'PL': 'üáµüá±', 'BR': 'üáßüá∑',
            'MX': 'üá≤üáΩ', 'AR': 'üá¶üá∑', 'IN': 'üáÆüá≥', 'CN': 'üá®üá≥', 'JP': 'üáØüáµ',
            'KR': 'üá∞üá∑', 'SG': 'üá∏üá¨', 'NZ': 'üá≥üáø', 'ZA': 'üáøüá¶', 'CH': 'üá®üá≠',
            'AT': 'üá¶üáπ', 'BE': 'üáßüá™', 'IE': 'üáÆüá™', 'PT': 'üáµüáπ', 'GR': 'üá¨üá∑',
            'RU': 'üá∑üá∫', 'TR': 'üáπüá∑', 'IL': 'üáÆüá±', 'AE': 'üá¶üá™', 'SA': 'üá∏üá¶',
            'EG': 'üá™üá¨', 'TH': 'üáπüá≠', 'MY': 'üá≤üáæ', 'ID': 'üáÆüá©', 'PH': 'üáµüá≠',
            'VN': 'üáªüá≥', 'HK': 'üá≠üá∞', 'TW': 'üáπüáº', 'CL': 'üá®üá±', 'CO': 'üá®üá¥',
            'PE': 'üáµüá™', 'VE': 'üáªüá™', 'UA': 'üá∫üá¶', 'CZ': 'üá®üáø', 'HU': 'üá≠üá∫',
            'RO': 'üá∑üá¥', 'BG': 'üáßüá¨', 'HR': 'üá≠üá∑', 'RS': 'üá∑üá∏', 'SK': 'üá∏üá∞',
            'SI': 'üá∏üáÆ', 'LT': 'üá±üáπ', 'LV': 'üá±üáª', 'EE': 'üá™üá™', 'IS': 'üáÆüá∏',
            'LU': 'üá±üá∫', 'MT': 'üá≤üáπ', 'CY': 'üá®üáæ', 'OTHER': 'üåç'
        };
        
        // Initialize leaderboard
        loadLeaderboard();
        
        function loadLeaderboard() {
            // Get all leaderboard data from localStorage
            const leaderboardData = JSON.parse(localStorage.getItem('leaderboard') || '[]');
            allLeaderboardData = leaderboardData;
            
            // Get current user data
            const userData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
            const currentUsername = userData.participantId || null;
            
            // If user is enrolled and has sessions, add/update their entry
            if (currentUsername && userData.studyData && userData.studyData.sessions) {
                updateUserInLeaderboard(currentUsername, userData.studyData.sessions);
            }
            
            // Display user stats if enrolled
            if (currentUsername) {
                displayUserStats(currentUsername);
            }
            
            // Display leaderboard
            displayLeaderboard();
        }
        
        function updateUserInLeaderboard(username, sessions) {
            if (!sessions || sessions.length === 0) return;
            
            // Calculate highest level achieved
            const highestLevel = Math.max(...sessions.map(s => s.nBackLevel || 2));
            const lastPlayed = new Date().toISOString();
            
            // Calculate best scores per level from sessions with supplement info
            const bestScores = {};
            const bestScoreSupplements = {};
            sessions.forEach(session => {
                const level = session.nBackLevel || 2;
                const totalScore = session.totalScore || (session.positionCorrect || 0) + (session.letterCorrect || 0);
                if (!bestScores[level] || totalScore > bestScores[level]) {
                    bestScores[level] = totalScore;
                    // Track supplements for this best score
                    const supplements = session.currentSupplements || (session.currentSupplement ? [session.currentSupplement] : []);
                    bestScoreSupplements[level] = supplements.filter(s => s && s.trim());
                }
            });
            
            // Get current leaderboard
            let leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
            
            // Find user entry or create new one
            const existingIndex = leaderboard.findIndex(entry => entry.username === username);
            
            if (existingIndex >= 0) {
                // Update existing entry
                leaderboard[existingIndex].highestLevel = Math.max(leaderboard[existingIndex].highestLevel, highestLevel);
                leaderboard[existingIndex].lastPlayed = lastPlayed;
                
                // Update best scores
                if (!leaderboard[existingIndex].bestScores) {
                    leaderboard[existingIndex].bestScores = {};
                }
                
                // Merge best scores and supplements
                if (!leaderboard[existingIndex].bestScoreSupplements) {
                    leaderboard[existingIndex].bestScoreSupplements = {};
                }
                
                Object.keys(bestScores).forEach(level => {
                    const currentBest = leaderboard[existingIndex].bestScores[level] || 0;
                    if (bestScores[level] > currentBest) {
                        leaderboard[existingIndex].bestScores[level] = bestScores[level];
                        leaderboard[existingIndex].bestScoreSupplements[level] = bestScoreSupplements[level] || [];
                    }
                });
            } else {
                // Get user data for country and workplace
                const userData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
                
                // Add new entry
                leaderboard.push({
                    username: username,
                    highestLevel: highestLevel,
                    lastPlayed: lastPlayed,
                    joinedDate: new Date().toISOString(),
                    country: userData.country || 'OTHER',
                    bestScores: bestScores,
                    bestScoreSupplements: bestScoreSupplements,
                    challengeWins: 0
                });
            }
            
            // Sort by highest level (descending), then by best score at highest level (descending), then by challenge wins
            leaderboard.sort((a, b) => {
                if (b.highestLevel !== a.highestLevel) {
                    return b.highestLevel - a.highestLevel;
                }
                
                // If same highest level, compare best scores at that level
                const aBestScore = a.bestScores && a.bestScores[a.highestLevel] ? a.bestScores[a.highestLevel] : 0;
                const bBestScore = b.bestScores && b.bestScores[b.highestLevel] ? b.bestScores[b.highestLevel] : 0;
                
                if (bBestScore !== aBestScore) {
                    return bBestScore - aBestScore;
                }
                
                // If same level and score, compare challenge wins
                const aChallengeWins = a.challengeWins || 0;
                const bChallengeWins = b.challengeWins || 0;
                
                if (bChallengeWins !== aChallengeWins) {
                    return bChallengeWins - aChallengeWins;
                }
                
                return new Date(b.lastPlayed) - new Date(a.lastPlayed);
            });
            
            // Save updated leaderboard
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
            allLeaderboardData = leaderboard;
        }
        
        function displayUserStats(username) {
            const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
            const userEntry = leaderboard.find(entry => entry.username === username);
            
            if (!userEntry) {
                document.getElementById('user-stats').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-label">Start playing to see your rank!</div>
                    </div>
                `;
                return;
            }
            
            const userRank = leaderboard.findIndex(entry => entry.username === username) + 1;
            const totalPlayers = leaderboard.length;
            const bestScore = userEntry.bestScores && userEntry.bestScores[userEntry.highestLevel] 
                ? userEntry.bestScores[userEntry.highestLevel] 
                : 'N/A';
            
            document.getElementById('user-stats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Your Rank</div>
                    <div class="stat-value">#${userRank}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Your Highest Level</div>
                    <div class="stat-value">${userEntry.highestLevel}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Your Best Score</div>
                    <div class="stat-value">${bestScore}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Your Challenge Wins</div>
                    <div class="stat-value">${userEntry.challengeWins || 0}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Players</div>
                    <div class="stat-value">${totalPlayers}</div>
                </div>
            `;
        }
        
        function displayLeaderboard() {
            const userData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
            const currentUsername = userData.participantId || null;
            
            let filteredData = [...allLeaderboardData];
            const tbody = document.getElementById('leaderboard-body');
            
            // Apply location filter
            if (currentLocationFilter !== 'all') {
                const userData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
                
                if (currentLocationFilter === 'country' && userData.country) {
                    filteredData = filteredData.filter(entry => entry.country === userData.country);
                }
            }
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data">No players found for this filter. Be the first!</td>
                    </tr>
                `;
                return;
            }
            
            // Display top 50 players
            tbody.innerHTML = filteredData.slice(0, 50).map((entry, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const isCurrentUser = entry.username === currentUsername;
                
                const countryFlag = countryFlags[entry.country] || countryFlags['OTHER'];
                
                // Get best score at highest level
                const bestScore = entry.bestScores && entry.bestScores[entry.highestLevel] 
                    ? entry.bestScores[entry.highestLevel] 
                    : 'N/A';
                
                // Get supplements used for best score
                const supplements = entry.bestScoreSupplements && entry.bestScoreSupplements[entry.highestLevel]
                    ? entry.bestScoreSupplements[entry.highestLevel].join(', ')
                    : '';

                // Challenge wins with special styling for top challenge winners
                const challengeWins = entry.challengeWins || 0;
                const challengeWinDisplay = challengeWins > 0 ? 
                    (challengeWins >= 10 ? `üèÜ ${challengeWins}` : 
                     challengeWins >= 5 ? `ü•á ${challengeWins}` : 
                     challengeWins >= 3 ? `ü•à ${challengeWins}` : 
                     challengeWins >= 1 ? `ü•â ${challengeWins}` : challengeWins) 
                    : '0';

                // Add special highlight for challenge champions (10+ wins)
                const challengeChampion = challengeWins >= 10;
                const challengeWinner = challengeWins >= 5;
                
                let rowClass = isCurrentUser ? 'user-highlight' : '';
                if (challengeChampion) {
                    rowClass += ' challenge-champion';
                } else if (challengeWinner) {
                    rowClass += ' challenge-winner';
                }
                
                return `
                    <tr class="${rowClass}">
                        <td style="text-align: center;">
                            <span class="rank ${rankClass}">${rank}${challengeChampion ? ' üëë' : ''}</span>
                        </td>
                        <td>
                            <span class="country-flag">${countryFlag}</span>
                            <span class="username">${entry.username}${isCurrentUser ? ' (You)' : ''}${challengeChampion ? ' üåü' : challengeWinner ? ' ‚≠ê' : ''}</span>
                        </td>
                        <td style="text-align: center;">
                            <span class="level">${entry.highestLevel}</span>
                        </td>
                        <td style="text-align: center;">
                            <span class="level">${bestScore}</span>
                        </td>
                        <td style="text-align: center; font-weight: bold; color: ${challengeWins >= 10 ? '#FFD700' : challengeWins >= 5 ? '#FFA500' : challengeWins >= 3 ? '#CD7F32' : challengeWins >= 1 ? '#4CAF50' : '#666'};">
                            ${challengeWinDisplay}
                        </td>
                        <td style="font-size: 0.9em; color: #666;">
                            ${supplements || 'No enhancements recorded'}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        
        function filterByLocation(location) {
            currentLocationFilter = location;
            
            // Update active button
            document.querySelectorAll('.location-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Display filtered leaderboard
            displayLeaderboard();
        }
        
        // Add some demo data if leaderboard is empty (remove this in production)
        if (allLeaderboardData.length === 0) {
            const demoData = [
                { username: "CognitiveMaster", highestLevel: 5, lastPlayed: new Date().toISOString(), country: "US", bestScores: { 5: 18, 4: 16, 3: 14 }, bestScoreSupplements: { 5: ["creatine", "lions-mane", "meditation"], 4: ["creatine", "choline"], 3: ["meditation"] }, challengeWins: 15 },
                { username: "BrainTrainer42", highestLevel: 5, lastPlayed: new Date().toISOString(), country: "GB", bestScores: { 5: 17, 4: 15, 3: 13 }, bestScoreSupplements: { 5: ["modafinil", "l-theanine-caffeine"], 4: ["l-theanine-caffeine"], 3: ["breathing-exercises"] }, challengeWins: 12 },
                { username: "MemoryChamp", highestLevel: 5, lastPlayed: new Date(Date.now() - 24*60*60*1000).toISOString(), country: "CA", bestScores: { 5: 15, 4: 14, 3: 12 }, bestScoreSupplements: { 5: ["bacopa", "phosphatidylserine"], 4: ["bacopa"], 3: [] }, challengeWins: 8 },
                { username: "NeuralNinja", highestLevel: 4, lastPlayed: new Date().toISOString(), country: "JP", bestScores: { 4: 16, 3: 14, 2: 12 }, bestScoreSupplements: { 4: ["huperzine-a", "meditation"], 3: ["meditation"], 2: [] }, challengeWins: 6 },
                { username: "FocusWarrior", highestLevel: 4, lastPlayed: new Date(Date.now() - 2*24*60*60*1000).toISOString(), country: "DE", bestScores: { 4: 14, 3: 13, 2: 11 }, bestScoreSupplements: { 4: ["aniracetam"], 3: [], 2: [] }, challengeWins: 3 },
                { username: "MindAthlete", highestLevel: 4, lastPlayed: new Date().toISOString(), country: "AU", bestScores: { 4: 15, 3: 13, 2: 11 }, bestScoreSupplements: { 4: ["creatine", "breathing-exercises"], 3: ["creatine"], 2: [] }, challengeWins: 2 },
                { username: "ThinkFast", highestLevel: 3, lastPlayed: new Date().toISOString(), country: "SE", bestScores: { 3: 13, 2: 12, 1: 10 }, bestScoreSupplements: { 3: ["nicotine"], 2: [], 1: [] }, challengeWins: 1 },
                { username: "Synaptic", highestLevel: 3, lastPlayed: new Date(Date.now() - 3*24*60*60*1000).toISOString(), country: "FR", bestScores: { 3: 14, 2: 12, 1: 10 }, bestScoreSupplements: { 3: ["pqq", "alcar"], 2: ["pqq"], 1: [] }, challengeWins: 0 }
            ];
            localStorage.setItem('leaderboard', JSON.stringify(demoData));
            loadLeaderboard();
        }
    </script>
</body>
</html>