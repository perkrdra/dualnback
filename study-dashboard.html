<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Training Dashboard - Track Your Cognitive Enhancement Progress | UltimateBrain.io</title>
    <meta name="description" content="Monitor your dual n-back training progress with detailed analytics. Track highest scores, view session history, manage cognitive supplements, and visualize your brain training improvements over time.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2552a3;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .progress-section {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .progress-chart {
            height: 300px;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .chart-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .supplement-tracker {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .collapsible-header:hover {
            opacity: 0.8;
        }
        
        .collapse-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        
        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }
        
        .supplement-content {
            max-height: 800px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .supplement-content.collapsed {
            max-height: 0;
        }
        
        .supplement-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .supplement-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
        }
        
        .supplement-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .save-btn {
            background-color: #2552a3;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .save-btn:hover {
            background-color: #1e4285;
        }
        
        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        .session-log {
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 20px;
        }
        
        .session-entry {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .session-entry:last-child {
            border-bottom: none;
        }
        
        .study-scores-list {
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 20px;
        }
        
        .study-score-entry {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            color: #2552a3;
        }
        
        .study-score-entry:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="/" class="domain-name">
            <img src="favicon.svg" alt="UltimateBrain.io Logo" class="logo-icon">
            UltimateBrain.io
        </a>
        <a href="/" class="study-link">Back</a>
    </div>

    <div id="game-container">
        <h1>Your Study Dashboard</h1>
        <p class="tagline">Track your cognitive enhancement progress</p>
        
        <div class="dashboard-container" id="dashboard-content">
            <!-- Content will be dynamically generated -->
        </div>
    </div>

    <script>
        // Reset highest score calculation by clearing old session data format
        // This is a one-time reset to ensure proper score calculation
        const resetKey = 'highestScoreReset_v2';
        if (!localStorage.getItem(resetKey)) {
            const userData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
            if (userData.studyData && userData.studyData.sessions) {
                // Reset all sessions to ensure clean score calculation
                userData.studyData.sessions = [];
                localStorage.setItem('studyUserData', JSON.stringify(userData));
                console.log('Reset session data for clean highest score tracking');
            }
            localStorage.setItem(resetKey, 'true');
        }

        // Check authentication
        const sessionToken = localStorage.getItem('sessionToken');
        const userData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
        const enrolled = localStorage.getItem('studyEnrolled');
        
        console.log('Dashboard access check:', { sessionToken: !!sessionToken, participantId: userData.participantId, enrolled });
        
        // Allow access if user has either a session token OR is enrolled (for backward compatibility)
        if ((!sessionToken && !enrolled) || !userData.participantId) {
            // Not logged in and not enrolled - redirect to login page
            document.getElementById('dashboard-content').innerHTML = `
                <div class="no-data">
                    <h2>Login Required</h2>
                    <p>Please log in to access your dashboard.</p>
                    <a href="login.html" class="save-btn" style="display: inline-block; text-decoration: none; margin-right: 10px;">Login</a>
                    <a href="study-enrollment.html" class="save-btn" style="display: inline-block; text-decoration: none; background-color: #28a745;">New User? Enroll</a>
                </div>
            `;
        } else if (sessionToken) {
            // Has session token - verify it's still valid
            verifySession().then(isValid => {
                if (isValid) {
                    displayDashboard();
                } else {
                    // Session expired or invalid
                    localStorage.removeItem('sessionToken');
                    localStorage.removeItem('studyUserData');
                    localStorage.removeItem('studyEnrolled');
                    window.location.href = 'login.html';
                }
            });
        } else {
            // Just enrolled (has enrolled flag and userData but no session token yet)
            // This is the case right after enrollment
            displayDashboard();
        }
        
        
        // Verify session with server (if available)
        async function verifySession() {
            try {
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // Update user data if server has newer version
                    if (result.userData) {
                        localStorage.setItem('studyUserData', JSON.stringify(result.userData));
                    }
                    return true;
                }
                
                return false;
            } catch (error) {
                console.log('Server verification failed, using localStorage fallback');
                // Fallback: just check if we have basic required data
                return sessionToken && userData.participantId && userData.password;
            }
        }
        
        function calculateStudyScores(sessions) {
            if (sessions.length === 0) {
                return { studyScores: [], examScore: null, currentStreak: 0, consecutiveDaysProgress: 0, todaysProgress: 0 };
            }
            
            // Get current user data to access supplements
            const currentUserData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
            const currentSupplements = currentUserData.studyData?.supplements || [];
            
            // Group sessions by date
            const sessionsByDate = {};
            sessions.forEach(session => {
                const date = new Date(session.timestamp).toDateString();
                if (!sessionsByDate[date]) {
                    sessionsByDate[date] = [];
                }
                sessionsByDate[date].push(session);
            });
            
            // Calculate study scores (1 point per day with 5+ sessions)
            const studyScores = [];
            let totalStudyPoints = 0;
            
            // Check each date for 5+ sessions requirement
            for (const [date, daySessions] of Object.entries(sessionsByDate)) {
                if (daySessions.length >= 5) {
                    const averageScore = Math.round(daySessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / daySessions.length);
                    const activeSupplement = getActiveSupplements(currentSupplements, new Date(date), sessions);
                    
                    studyScores.push({
                        completedDate: new Date(date),
                        score: averageScore,
                        sessionsCompleted: daySessions.length,
                        supplements: activeSupplement
                    });
                    totalStudyPoints++;
                }
            }
            
            // Calculate today's progress (how many sessions completed today)
            const today = new Date().toDateString();
            const todaysProgress = sessionsByDate[today]?.length || 0;
            
            // Calculate exam score (still based on 25 consecutive days with 10+ sessions)
            const sortedDates = Object.keys(sessionsByDate).sort((a, b) => new Date(a) - new Date(b));
            const qualifyingDays = [];
            for (const date of sortedDates) {
                if (sessionsByDate[date].length >= 10) {
                    qualifyingDays.push({
                        date: new Date(date),
                        sessionsCount: sessionsByDate[date].length,
                        averageScore: Math.round(sessionsByDate[date].reduce((sum, s) => sum + (s.totalScore || 0), 0) / sessionsByDate[date].length)
                    });
                }
            }
            
            let examScore = null;
            let currentStreak = 0;
            
            // Check for exam score (25 consecutive days with 10+ sessions)
            let i = 0;
            while (i < qualifyingDays.length) {
                let consecutiveCount = 1;
                let currentDate = qualifyingDays[i].date;
                let totalScore = qualifyingDays[i].averageScore;
                
                // Count consecutive days
                while (i + consecutiveCount < qualifyingDays.length) {
                    const nextDate = qualifyingDays[i + consecutiveCount].date;
                    const dayDifference = (nextDate - currentDate) / (1000 * 60 * 60 * 24);
                    
                    if (dayDifference === consecutiveCount) {
                        totalScore += qualifyingDays[i + consecutiveCount].averageScore;
                        consecutiveCount++;
                        currentDate = nextDate;
                    } else {
                        break;
                    }
                }
                
                // Check for exam score (25 consecutive days)
                if (consecutiveCount >= 25 && !examScore) {
                    const groupAverageScore = Math.round(totalScore / consecutiveCount);
                    const activeSupplements = getActiveSupplements(currentSupplements, qualifyingDays[i].date, sessions);
                    examScore = {
                        score: groupAverageScore,
                        supplements: activeSupplements,
                        completedDate: new Date(qualifyingDays[i].date)
                    };
                }
                
                // Update current streak for exam progress
                const today = new Date();
                const lastDayInGroup = new Date(qualifyingDays[i].date);
                lastDayInGroup.setDate(lastDayInGroup.getDate() + consecutiveCount - 1);
                const daysSinceLastDay = Math.floor((today - lastDayInGroup) / (1000 * 60 * 60 * 24));
                
                if (daysSinceLastDay <= 1) {
                    currentStreak = consecutiveCount;
                }
                
                i += consecutiveCount;
            }
            
            return { 
                studyScores, 
                examScore, 
                currentStreak, 
                consecutiveDaysProgress: 0, // Not used in new system
                todaysProgress,
                totalStudyPoints
            };
        }
        
        // Helper function to get supplements that were active during a specific period
        function getActiveSupplements(currentSupplements, achievementDate, sessions) {
            // First try to get supplements from session data during that period
            const sessionSupplements = new Set();
            
            // Look at sessions around the achievement date to find which supplements were used
            const achievementTime = achievementDate.getTime();
            const oneDayMs = 24 * 60 * 60 * 1000;
            
            sessions.forEach(session => {
                const sessionTime = new Date(session.timestamp).getTime();
                // Include sessions from 5 days before to 5 days after achievement
                if (Math.abs(sessionTime - achievementTime) <= 5 * oneDayMs) {
                    // Handle both new array format and legacy single supplement format
                    if (session.currentSupplements && Array.isArray(session.currentSupplements)) {
                        session.currentSupplements.forEach(supplement => {
                            if (supplement && supplement.trim()) {
                                sessionSupplements.add(supplement);
                            }
                        });
                    } else if (session.currentSupplement && session.currentSupplement.trim()) {
                        sessionSupplements.add(session.currentSupplement);
                    }
                }
            });
            
            // If we found supplements from sessions, use those
            if (sessionSupplements.size > 0) {
                return Array.from(sessionSupplements).map(supplement => ({ name: supplement }));
            }
            
            // Fallback to current supplement profile (legacy behavior)
            if (!currentSupplements || currentSupplements.length === 0) {
                return [];
            }
            
            return currentSupplements.map(supplement => {
                if (typeof supplement === 'string') {
                    // Handle simple string format (legacy)
                    return { name: supplement };
                } else if (supplement.name) {
                    // Handle object format with name
                    return { name: supplement.name, dosage: supplement.dosage };
                }
                return { name: supplement };
            });
        }
        
        function displayDashboard() {
            const sessions = userData.studyData.sessions || [];
            const supplements = userData.studyData.supplements || [];
            
            // Calculate statistics
            const totalSessions = sessions.length;
            
            // Find session with highest score (only count sessions with 30 trials)
            const completedSessions = sessions.filter(s => (s.trialsCompleted || s.totalTrials) >= 30);
            const highestScoringSession = completedSessions.reduce((highest, current) => {
                // Use totalScore directly - it represents total matches found (position + letter)
                const currentScore = current.totalScore || 0;
                const highestScore = highest.totalScore || 0;
                return currentScore > highestScore ? current : highest;
            }, { totalScore: 0 });
            
            const highestLevel = Math.max(...sessions.map(s => s.nBackLevel || 2), 2);
            
            // Calculate highest score per N-back level
            const scoresByLevel = {};
            completedSessions.forEach(session => {
                const level = session.nBackLevel || 2;
                const score = session.totalScore || 0;
                if (!scoresByLevel[level] || score > scoresByLevel[level].score) {
                    scoresByLevel[level] = {
                        score: score,
                        session: session,
                        supplements: session.currentSupplements || (session.currentSupplement ? [session.currentSupplement] : [])
                    };
                }
            });
            
            // Calculate study scores and exam score
            const { studyScores, examScore, currentStreak, consecutiveDaysProgress, todaysProgress, totalStudyPoints } = calculateStudyScores(sessions);
            
            const dashboardHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Sessions</div>
                        <div class="stat-value">${totalSessions}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Highest Score</div>
                        <div class="stat-value">${highestScoringSession.totalScore || 0}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">${(highestScoringSession.totalScore || 0) > 0 ? 'Level ' + (highestScoringSession.nBackLevel || 2) + ' | ' + (highestScoringSession.trialsCompleted || 30) + ' trials' : 'Complete a 30-trial session'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Highest N-Back</div>
                        <div class="stat-value">${highestLevel}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Study Points</div>
                        <div class="stat-value">${totalStudyPoints || studyScores.length}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            1 point per day with 5+ sessions
                            <br><span style="color: #2552a3; font-weight: bold;">Today: ${todaysProgress}/5 sessions</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Exam Score</div>
                        <div class="stat-value">${examScore ? examScore.score : 'Not achieved'}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">${examScore ? 'Completed 25 days!' : currentStreak + ' of 25 consecutive days'}</div>
                    </div>
                </div>
                
                ${sessions.length > 0 ? `
                <div class="progress-section">
                    <h2>Progress Over Time</h2>
                    <p>Track your Total Score progression across sessions:</p>
                    <div class="progress-chart">
                        <canvas id="progress-canvas" class="chart-canvas"></canvas>
                    </div>
                </div>
                ` : ''}
                
                <div class="supplement-tracker">
                    <div class="collapsible-header" onclick="toggleSupplementSection()">
                        <div>
                            <h2>Track Your Enhancements & Techniques</h2>
                            <p>Select what you're currently using to enhance your training:</p>
                        </div>
                        <div class="collapse-icon" id="collapse-icon">▼</div>
                    </div>
                    <div class="supplement-content" id="supplement-content">
                        <div class="supplement-list">
                            <div class="supplement-item">
                                <input type="checkbox" id="creatine" ${supplements.includes('creatine') ? 'checked' : ''}>
                                <label for="creatine">Creatine</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="choline" ${supplements.includes('choline') ? 'checked' : ''}>
                                <label for="choline">Choline</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="lions-mane" ${supplements.includes('lions-mane') ? 'checked' : ''}>
                                <label for="lions-mane">Lion's Mane</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="bacopa" ${supplements.includes('bacopa') ? 'checked' : ''}>
                                <label for="bacopa">Bacopa Monnieri</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="l-theanine-caffeine" ${supplements.includes('l-theanine-caffeine') ? 'checked' : ''}>
                                <label for="l-theanine-caffeine">L-Theanine + Caffeine</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="pqq" ${supplements.includes('pqq') ? 'checked' : ''}>
                                <label for="pqq">PQQ</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="phosphatidylserine" ${supplements.includes('phosphatidylserine') ? 'checked' : ''}>
                                <label for="phosphatidylserine">Phosphatidylserine</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="aniracetam" ${supplements.includes('aniracetam') ? 'checked' : ''}>
                                <label for="aniracetam">Aniracetam</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="huperzine-a" ${supplements.includes('huperzine-a') ? 'checked' : ''}>
                                <label for="huperzine-a">Huperzine A</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="modafinil" ${supplements.includes('modafinil') ? 'checked' : ''}>
                                <label for="modafinil">Modafinil</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="alcar" ${supplements.includes('alcar') ? 'checked' : ''}>
                                <label for="alcar">ALCAR</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="caprylic-acid" ${supplements.includes('caprylic-acid') ? 'checked' : ''}>
                                <label for="caprylic-acid">Caprylic Acid (C8)</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="borage-oil" ${supplements.includes('borage-oil') ? 'checked' : ''}>
                                <label for="borage-oil">Borage Oil</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="sleep-pineal-peptides" ${supplements.includes('sleep-pineal-peptides') ? 'checked' : ''}>
                                <label for="sleep-pineal-peptides">Sleep Optimization</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="breathing-exercises" ${supplements.includes('breathing-exercises') ? 'checked' : ''}>
                                <label for="breathing-exercises">Breathing Exercises</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="meditation" ${supplements.includes('meditation') ? 'checked' : ''}>
                                <label for="meditation">Meditation</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="nicotine" ${supplements.includes('nicotine') ? 'checked' : ''}>
                                <label for="nicotine">Nicotine (Occasional)</label>
                            </div>
                            <div class="supplement-item">
                                <input type="checkbox" id="other" ${supplements.includes('other') ? 'checked' : ''}>
                                <label for="other">Other</label>
                            </div>
                        </div>
                        <button class="save-btn" onclick="saveSupplements()">Save Enhancements</button>
                    </div>
                </div>
                
                ${studyScores.length > 0 ? `
                <div class="progress-section">
                    <h2>Study Points Earned</h2>
                    <p>Each study point represents a day where you completed 5+ training sessions. Keep the streak alive!</p>
                    <div class="study-scores-list">
                        ${studyScores.map((score, index) => `
                            <div class="study-score-entry">
                                <strong>Study Point #${index + 1}</strong> - 
                                Average Score: ${score.score} | 
                                Date: ${score.completedDate.toLocaleDateString()} | 
                                ${score.sessionsCompleted} sessions completed
                                ${score.supplements && score.supplements.length > 0 ? `
                                    <br><span style="font-size: 0.9em; color: #2552a3; font-weight: normal;">
                                        Enhancements: ${score.supplements.map(s => s.name).join(', ')}
                                    </span>
                                ` : '<br><span style="font-size: 0.9em; color: #666; font-weight: normal;">No enhancements recorded</span>'}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${examScore ? `
                <div class="progress-section">
                    <h2>Exam Score Achieved</h2>
                    <p>Congratulations! You completed 25 consecutive days of 10+ training sessions daily.</p>
                    <div class="study-scores-list">
                        <div class="study-score-entry" style="background-color: #f0f8ff; border-left: 4px solid #2552a3;">
                            <strong>🎓 Exam Score</strong> - 
                            Score: ${examScore.score} | 
                            Completed: ${examScore.completedDate.toLocaleDateString()} | 
                            25 consecutive days
                            ${examScore.supplements && examScore.supplements.length > 0 ? `
                                <br><span style="font-size: 0.9em; color: #2552a3; font-weight: normal;">
                                    Supplements: ${examScore.supplements.map(s => s.name).join(', ')}
                                </span>
                            ` : '<br><span style="font-size: 0.9em; color: #666; font-weight: normal;">No supplements recorded</span>'}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${Object.keys(scoresByLevel).length > 0 ? `
                <div class="progress-section">
                    <h2>Highest Scores by N-Back Level</h2>
                    <p>Your best performance at each difficulty level:</p>
                    <div class="study-scores-list">
                        ${Object.keys(scoresByLevel).sort((a, b) => parseInt(a) - parseInt(b)).map(level => {
                            const levelData = scoresByLevel[level];
                            const activeSupplement = levelData.supplements && levelData.supplements.length > 0 
                                ? levelData.supplements.filter(s => s && s.trim()).join(', ')
                                : '';
                            return `
                            <div class="study-score-entry">
                                <strong>Level ${level}-Back</strong> - 
                                Highest Score: ${levelData.score}
                                ${activeSupplement ? `
                                    <br><span style="font-size: 0.9em; color: #2552a3; font-weight: normal;">
                                        Enhancements used: ${activeSupplement}
                                    </span>
                                ` : '<br><span style="font-size: 0.9em; color: #666; font-weight: normal;">No enhancements recorded</span>'}
                            </div>
                        `}).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('dashboard-content').innerHTML = dashboardHTML;
            
            // Draw progress chart if there are sessions
            if (sessions.length > 0) {
                setTimeout(() => drawProgressChart(sessions), 100);
            }
        }
        
        function drawProgressChart(sessions) {
            const canvas = document.getElementById('progress-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            // Set canvas size to match display size
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            const width = rect.width;
            const height = rect.height;
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // Prepare data - use more sessions for wider layout (last 50 sessions)
            const recentSessions = sessions.slice(-50);
            const scores = recentSessions.map(s => s.totalScore || 0);
            const maxScore = Math.max(...scores, 1);
            const minScore = Math.min(...scores, 0);
            const scoreRange = Math.max(maxScore - minScore, 1);
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid lines
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines (fewer for compact layout)
            for (let i = 0; i <= 4; i++) {
                const y = padding + (i * chartHeight / 4);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels (smaller font for horizontal layout)
                const value = Math.round(maxScore - (i * scoreRange / 4));
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(value.toString(), padding - 5, y + 3);
            }
            
            // Vertical grid lines (more spaced out for horizontal emphasis)
            const stepSize = Math.max(1, Math.floor(recentSessions.length / 8));
            for (let i = 0; i < recentSessions.length; i += stepSize) {
                const x = padding + (i * chartWidth / Math.max(recentSessions.length - 1, 1));
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, height - padding);
                ctx.stroke();
            }
            
            // Draw the line chart
            if (recentSessions.length > 0) {
                ctx.strokeStyle = '#2552a3';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                recentSessions.forEach((session, index) => {
                    const x = padding + (index * chartWidth / Math.max(recentSessions.length - 1, 1));
                    const normalizedScore = (scores[index] - minScore) / scoreRange;
                    const y = padding + chartHeight - (normalizedScore * chartHeight);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // Draw data points (smaller for horizontal layout)
                ctx.fillStyle = '#2552a3';
                recentSessions.forEach((session, index) => {
                    const x = padding + (index * chartWidth / Math.max(recentSessions.length - 1, 1));
                    const normalizedScore = (scores[index] - minScore) / scoreRange;
                    const y = padding + chartHeight - (normalizedScore * chartHeight);
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 2, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                // Add trend line
                if (recentSessions.length > 1) {
                    const firstScore = scores[0];
                    const lastScore = scores[scores.length - 1];
                    const firstY = padding + chartHeight - ((firstScore - minScore) / scoreRange * chartHeight);
                    const lastY = padding + chartHeight - ((lastScore - minScore) / scoreRange * chartHeight);
                    
                    ctx.strokeStyle = '#ea6a4b';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(padding, firstY);
                    ctx.lineTo(width - padding, lastY);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            // Y-axis
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            // X-axis
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Add labels (optimized for horizontal layout)
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Recent Sessions →', width / 2, height - 5);
            
            ctx.save();
            ctx.translate(10, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.font = 'bold 10px Arial';
            ctx.fillText('Score', 0, 0);
            ctx.restore();
        }
        
        function toggleSupplementSection() {
            const content = document.getElementById('supplement-content');
            const icon = document.getElementById('collapse-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = '▶';
            }
        }
        
        function saveSupplements() {
            const checkboxes = document.querySelectorAll('.supplement-item input[type="checkbox"]');
            const supplements = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    supplements.push(checkbox.id);
                }
            });
            
            userData.studyData.supplements = supplements;
            localStorage.setItem('studyUserData', JSON.stringify(userData));
            
            alert('Supplements saved successfully!');
        }
        
        // Top bar scroll hide functionality
        let lastScrollY = window.scrollY;
        const navigationBar = document.querySelector('.top-bar');
        
        function handleScroll() {
            const currentScrollY = window.scrollY;
            
            // Hide top bar when scrolling down past 100px
            if (currentScrollY > 100) {
                navigationBar.classList.add('hidden');
            } else {
                navigationBar.classList.remove('hidden');
            }
            
            lastScrollY = currentScrollY;
        }
        
        // Add scroll event listener with throttling for better performance
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            scrollTimeout = setTimeout(handleScroll, 10);
        });
    </script>
</body>
</html>