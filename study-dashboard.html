<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Dashboard - UltimateBrain.io</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .dashboard-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2552a3;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .progress-section {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .progress-chart {
            height: 300px;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .supplement-tracker {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .supplement-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .supplement-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
        }
        
        .supplement-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .save-btn {
            background-color: #2552a3;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .save-btn:hover {
            background-color: #1e4285;
        }
        
        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        .session-log {
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 20px;
        }
        
        .session-entry {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .session-entry:last-child {
            border-bottom: none;
        }
        
        .study-scores-list {
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 20px;
        }
        
        .study-score-entry {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            color: #2552a3;
        }
        
        .study-score-entry:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="/" class="domain-name">
            <img src="favicon.svg" alt="UltimateBrain.io Logo" class="logo-icon">
            UltimateBrain.io
        </a>
        <div>
            <a href="/" class="study-link">Back to Training</a>
            <button id="logout-btn" class="study-link" style="background-color: #dc3545; margin-left: 10px;">Logout</button>
        </div>
    </div>

    <div id="game-container">
        <h1>Your Study Dashboard</h1>
        <p class="tagline">Track your cognitive enhancement progress</p>
        
        <div class="dashboard-container" id="dashboard-content">
            <!-- Content will be dynamically generated -->
        </div>
    </div>

    <script>
        // Check authentication
        const sessionToken = localStorage.getItem('sessionToken');
        const userData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
        const enrolled = localStorage.getItem('studyEnrolled');
        
        console.log('Dashboard access check:', { sessionToken: !!sessionToken, participantId: userData.participantId, enrolled });
        
        // Allow access if user has either a session token OR is enrolled (for backward compatibility)
        if ((!sessionToken && !enrolled) || !userData.participantId) {
            // Not logged in and not enrolled - redirect to login page
            document.getElementById('dashboard-content').innerHTML = `
                <div class="no-data">
                    <h2>Login Required</h2>
                    <p>Please log in to access your dashboard.</p>
                    <a href="login.html" class="save-btn" style="display: inline-block; text-decoration: none; margin-right: 10px;">Login</a>
                    <a href="study-enrollment.html" class="save-btn" style="display: inline-block; text-decoration: none; background-color: #28a745;">New User? Enroll</a>
                </div>
            `;
        } else if (sessionToken) {
            // Has session token - verify it's still valid
            verifySession().then(isValid => {
                if (isValid) {
                    displayDashboard();
                } else {
                    // Session expired or invalid
                    localStorage.removeItem('sessionToken');
                    localStorage.removeItem('studyUserData');
                    localStorage.removeItem('studyEnrolled');
                    window.location.href = 'login.html';
                }
            });
        } else {
            // Just enrolled (has enrolled flag and userData but no session token yet)
            // This is the case right after enrollment
            displayDashboard();
        }
        
        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('sessionToken');
                localStorage.removeItem('studyUserData');
                localStorage.removeItem('studyEnrolled');
                window.location.href = '/';
            }
        });
        
        // Verify session with server (if available)
        async function verifySession() {
            try {
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // Update user data if server has newer version
                    if (result.userData) {
                        localStorage.setItem('studyUserData', JSON.stringify(result.userData));
                    }
                    return true;
                }
                
                return false;
            } catch (error) {
                console.log('Server verification failed, using localStorage fallback');
                // Fallback: just check if we have basic required data
                return sessionToken && userData.participantId && userData.password;
            }
        }
        
        function calculateStudyScores(sessions) {
            if (sessions.length === 0) {
                return { studyScores: [], examScore: null, currentStreak: 0 };
            }
            
            // Get current user data to access supplements
            const currentUserData = JSON.parse(localStorage.getItem('studyUserData') || '{}');
            const currentSupplements = currentUserData.studyData?.supplements || [];
            
            // Group sessions by date
            const sessionsByDate = {};
            sessions.forEach(session => {
                const date = new Date(session.timestamp).toDateString();
                if (!sessionsByDate[date]) {
                    sessionsByDate[date] = [];
                }
                sessionsByDate[date].push(session);
            });
            
            // Get sorted dates
            const sortedDates = Object.keys(sessionsByDate).sort((a, b) => new Date(a) - new Date(b));
            
            // Track consecutive days with 10+ sessions
            const studyScores = [];
            let currentStreak = 0;
            let streakStartDate = null;
            let consecutiveDays = 0;
            let examScore = null;
            
            // Check each date for 10+ sessions requirement
            const qualifyingDays = [];
            for (const date of sortedDates) {
                if (sessionsByDate[date].length >= 10) {
                    qualifyingDays.push({
                        date: new Date(date),
                        sessionsCount: sessionsByDate[date].length,
                        averageScore: Math.round(sessionsByDate[date].reduce((sum, s) => sum + (s.totalScore || 0), 0) / sessionsByDate[date].length)
                    });
                }
            }
            
            // Process consecutive qualifying days
            let i = 0;
            while (i < qualifyingDays.length) {
                let consecutiveCount = 1;
                let currentDate = qualifyingDays[i].date;
                let groupAverageScore = qualifyingDays[i].averageScore;
                let totalScore = qualifyingDays[i].averageScore;
                
                // Count consecutive days
                while (i + consecutiveCount < qualifyingDays.length) {
                    const nextDate = qualifyingDays[i + consecutiveCount].date;
                    const dayDifference = (nextDate - currentDate) / (1000 * 60 * 60 * 24);
                    
                    if (dayDifference === consecutiveCount) {
                        totalScore += qualifyingDays[i + consecutiveCount].averageScore;
                        consecutiveCount++;
                        currentDate = nextDate;
                    } else {
                        break;
                    }
                }
                
                // Calculate group average score
                groupAverageScore = Math.round(totalScore / consecutiveCount);
                
                // Get supplements that were active during this period
                const activeSuuplements = getActiveSupplements(currentSupplements, qualifyingDays[i].date, sessions);
                
                // Award study scores for every 5 consecutive days
                const studyPeriodsCompleted = Math.floor(consecutiveCount / 5);
                for (let period = 0; period < studyPeriodsCompleted; period++) {
                    const periodEndDate = new Date(qualifyingDays[i].date);
                    periodEndDate.setDate(periodEndDate.getDate() + ((period + 1) * 5) - 1);
                    
                    studyScores.push({
                        completedDate: periodEndDate,
                        score: groupAverageScore,
                        daysInStreak: (period + 1) * 5,
                        supplements: activeSuuplements
                    });
                }
                
                // Check for exam score (25 consecutive days)
                if (consecutiveCount >= 25 && !examScore) {
                    examScore = {
                        score: groupAverageScore,
                        supplements: activeSuuplements,
                        completedDate: new Date(qualifyingDays[i].date)
                    };
                }
                
                // Update current streak if this is the most recent group and includes today or recent days
                const today = new Date();
                const lastDayInGroup = new Date(qualifyingDays[i].date);
                lastDayInGroup.setDate(lastDayInGroup.getDate() + consecutiveCount - 1);
                const daysSinceLastDay = Math.floor((today - lastDayInGroup) / (1000 * 60 * 60 * 24));
                
                if (daysSinceLastDay <= 1) { // If the streak ended today or yesterday
                    currentStreak = consecutiveCount;
                }
                
                i += consecutiveCount;
            }
            
            return { studyScores, examScore, currentStreak };
        }
        
        // Helper function to get supplements that were active during a specific period
        function getActiveSupplements(currentSupplements, achievementDate, sessions) {
            // First try to get supplements from session data during that period
            const sessionSupplements = new Set();
            
            // Look at sessions around the achievement date to find which supplements were used
            const achievementTime = achievementDate.getTime();
            const oneDayMs = 24 * 60 * 60 * 1000;
            
            sessions.forEach(session => {
                const sessionTime = new Date(session.timestamp).getTime();
                // Include sessions from 5 days before to 5 days after achievement
                if (Math.abs(sessionTime - achievementTime) <= 5 * oneDayMs) {
                    // Handle both new array format and legacy single supplement format
                    if (session.currentSupplements && Array.isArray(session.currentSupplements)) {
                        session.currentSupplements.forEach(supplement => {
                            if (supplement && supplement.trim()) {
                                sessionSupplements.add(supplement);
                            }
                        });
                    } else if (session.currentSupplement && session.currentSupplement.trim()) {
                        sessionSupplements.add(session.currentSupplement);
                    }
                }
            });
            
            // If we found supplements from sessions, use those
            if (sessionSupplements.size > 0) {
                return Array.from(sessionSupplements).map(supplement => ({ name: supplement }));
            }
            
            // Fallback to current supplement profile (legacy behavior)
            if (!currentSupplements || currentSupplements.length === 0) {
                return [];
            }
            
            return currentSupplements.map(supplement => {
                if (typeof supplement === 'string') {
                    // Handle simple string format (legacy)
                    return { name: supplement };
                } else if (supplement.name) {
                    // Handle object format with name
                    return { name: supplement.name, dosage: supplement.dosage };
                }
                return { name: supplement };
            });
        }
        
        function displayDashboard() {
            const sessions = userData.studyData.sessions || [];
            const supplements = userData.studyData.supplements || [];
            
            // Calculate statistics
            const totalSessions = sessions.length;
            
            // Find session with highest score (only count sessions with 30 trials)
            const completedSessions = sessions.filter(s => (s.trialsCompleted || s.totalTrials) >= 30);
            const highestScoringSession = completedSessions.reduce((highest, current) => {
                const currentScore = current.totalScore || 0;
                const highestScore = highest.totalScore || 0;
                return currentScore > highestScore ? current : highest;
            }, { totalScore: 0 });
            
            const highestLevel = Math.max(...sessions.map(s => s.nBackLevel || 2), 2);
            
            // Calculate study scores and exam score
            const { studyScores, examScore, currentStreak } = calculateStudyScores(sessions);
            
            const dashboardHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Sessions</div>
                        <div class="stat-value">${totalSessions}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Session with Highest Score</div>
                        <div class="stat-value">${highestScoringSession.totalScore || 0}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">${highestScoringSession.totalScore > 0 ? 'Level ' + (highestScoringSession.nBackLevel || 2) + ' | ' + (highestScoringSession.trialsCompleted || 30) + ' trials' : 'Complete a 30-trial session'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Highest N-Back</div>
                        <div class="stat-value">${highestLevel}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Study Scores</div>
                        <div class="stat-value">${studyScores.length}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">${studyScores.length > 0 ? 'Latest: ' + studyScores[studyScores.length - 1].score : 'Complete 5 consecutive days'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Exam Score</div>
                        <div class="stat-value">${examScore ? examScore.score : 'Not achieved'}</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">${examScore ? 'Completed 25 days!' : 'Current streak: ' + currentStreak + '/25'}</div>
                    </div>
                </div>
                
                <div class="supplement-tracker">
                    <h2>Track Your Supplements & Techniques</h2>
                    <p>Select what you're currently using to enhance your training:</p>
                    <div class="supplement-list">
                        <div class="supplement-item">
                            <input type="checkbox" id="creatine" ${supplements.includes('creatine') ? 'checked' : ''}>
                            <label for="creatine">Creatine</label>
                        </div>
                        <div class="supplement-item">
                            <input type="checkbox" id="choline" ${supplements.includes('choline') ? 'checked' : ''}>
                            <label for="choline">Choline</label>
                        </div>
                        <div class="supplement-item">
                            <input type="checkbox" id="lions-mane" ${supplements.includes('lions-mane') ? 'checked' : ''}>
                            <label for="lions-mane">Lion's Mane</label>
                        </div>
                        <div class="supplement-item">
                            <input type="checkbox" id="breathing" ${supplements.includes('breathing') ? 'checked' : ''}>
                            <label for="breathing">Breathing Exercises</label>
                        </div>
                        <div class="supplement-item">
                            <input type="checkbox" id="meditation" ${supplements.includes('meditation') ? 'checked' : ''}>
                            <label for="meditation">Meditation</label>
                        </div>
                        <div class="supplement-item">
                            <input type="checkbox" id="other" ${supplements.includes('other') ? 'checked' : ''}>
                            <label for="other">Other Supplements</label>
                        </div>
                    </div>
                    <button class="save-btn" onclick="saveSupplements()">Save Supplements</button>
                </div>
                
                ${studyScores.length > 0 ? `
                <div class="progress-section">
                    <h2>Study Scores Achieved</h2>
                    <p>Each study score represents 5 consecutive days of completing 10+ training sessions daily.</p>
                    <div class="study-scores-list">
                        ${studyScores.map((score, index) => `
                            <div class="study-score-entry">
                                <strong>Study Score #${index + 1}</strong> - 
                                Score: ${score.score} | 
                                Completed: ${score.completedDate.toLocaleDateString()} | 
                                ${score.daysInStreak} consecutive days
                                ${score.supplements && score.supplements.length > 0 ? `
                                    <br><span style="font-size: 0.9em; color: #2552a3; font-weight: normal;">
                                        Supplements: ${score.supplements.map(s => s.name).join(', ')}
                                    </span>
                                ` : '<br><span style="font-size: 0.9em; color: #666; font-weight: normal;">No supplements recorded</span>'}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${examScore ? `
                <div class="progress-section">
                    <h2>Exam Score Achieved</h2>
                    <p>Congratulations! You completed 25 consecutive days of 10+ training sessions daily.</p>
                    <div class="study-scores-list">
                        <div class="study-score-entry" style="background-color: #f0f8ff; border-left: 4px solid #2552a3;">
                            <strong>🎓 Exam Score</strong> - 
                            Score: ${examScore.score} | 
                            Completed: ${examScore.completedDate.toLocaleDateString()} | 
                            25 consecutive days
                            ${examScore.supplements && examScore.supplements.length > 0 ? `
                                <br><span style="font-size: 0.9em; color: #2552a3; font-weight: normal;">
                                    Supplements: ${examScore.supplements.map(s => s.name).join(', ')}
                                </span>
                            ` : '<br><span style="font-size: 0.9em; color: #666; font-weight: normal;">No supplements recorded</span>'}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="progress-section">
                    <h2>Recent Sessions</h2>
                    <div class="session-log">
                        ${sessions.length === 0 ? '<p class="no-data">No sessions recorded yet. Start training to see your progress!</p>' : 
                          sessions.slice(-10).reverse().map(session => `
                            <div class="session-entry">
                                <strong>${new Date(session.timestamp).toLocaleDateString()}</strong> - 
                                Level ${session.nBackLevel || 2} | 
                                Score: ${session.totalScore || 0} | 
                                Position: ${session.positionCorrect || 0}/${session.positionTotal || 0} | 
                                Letter: ${session.letterCorrect || 0}/${session.letterTotal || 0}
                            </div>
                          `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('dashboard-content').innerHTML = dashboardHTML;
        }
        
        function saveSupplements() {
            const checkboxes = document.querySelectorAll('.supplement-item input[type="checkbox"]');
            const supplements = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    supplements.push(checkbox.id);
                }
            });
            
            userData.studyData.supplements = supplements;
            localStorage.setItem('studyUserData', JSON.stringify(userData));
            
            alert('Supplements saved successfully!');
        }
    </script>
</body>
</html>